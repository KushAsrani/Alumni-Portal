---
export const prerender = false; // Disable prerendering for SSR

import Layout from '../../layouts/Layout.astro';
import { authenticateUser, setAuthCookie, isAuthenticated } from '../../lib/auth';

let errorMessage = '';

// Check if already authenticated
try {
  const alreadyAuthenticated = isAuthenticated(Astro.cookies);
  
  if (alreadyAuthenticated) {
    return Astro.redirect('/admin/scraper-dashboard');
  }
} catch (error) {
  console.error('Auth check error:', error);
}

// Handle login form submission
if (Astro.request.method === 'POST') {
  try {
    // Get form data with proper content type handling
    const contentType = Astro.request.headers.get('content-type') || '';
    
    let username = '';
    let password = '';
    
    if (contentType.includes('application/x-www-form-urlencoded')) {
      const formData = await Astro.request.formData();
      username = formData.get('username')?.toString()?.trim() || '';
      password = formData.get('password')?.toString()?.trim() || '';
    } else {
      // Fallback for incorrect content type
      const body = await Astro.request.text();
      const params = new URLSearchParams(body);
      username = params.get('username')?.trim() || '';
      password = params.get('password')?.trim() || '';
    }
    
    console.log('Login attempt for username:', username);
    
    if (!username || !password) {
      errorMessage = 'Please enter both username and password';
    } else if (authenticateUser(username, password)) {
      console.log('Authentication successful for:', username);
      
      // Set authentication cookie
      setAuthCookie(Astro.cookies, username);
      
      // Redirect to dashboard
      return Astro.redirect('/admin/scraper-dashboard');
    } else {
      console.log('Authentication failed for:', username);
      errorMessage = 'Invalid username or password';
    }
  } catch (error) {
    console.error('Login error:', error);
    errorMessage = 'An error occurred during login. Please try again.';
  }
}
---

<Layout title="Admin Login | Alumni Portal">
  <main class="login-page">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <h1>Admin Login</h1>
          <p>Admin Dashboard</p>
        </div>

        {errorMessage && (
          <div class="error-message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{errorMessage}</span>
          </div>
        )}

        <!-- FIXED: Explicit form encoding -->
        <form method="POST" action="/admin/login" enctype="application/x-www-form-urlencoded" class="login-form">
          <div class="form-group">
            <label for="username">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Username
            </label>
            <input
              type="text"
              id="username"
              name="username"
              class="form-input"
              placeholder="Enter username"
              required
              autocomplete="username"
              autofocus
            />
          </div>

          <div class="form-group">
            <label for="password">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              placeholder="Enter password"
              required
              autocomplete="current-password"
            />
          </div>

          <button type="submit" class="login-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            Login
          </button>
        </form>

        <div class="login-footer">
          <a href="/">‚Üê Back to Home</a>
        </div>

        <!-- Demo Credentials Notice -->
        <div class="demo-notice">
          <strong>üîë Demo Credentials:</strong><br/>
          Username: <code>admin</code><br/>
          Password: <code>admin123</code>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .login-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
  }

  .login-container {
    width: 100%;
    max-width: 420px;
  }

  .login-card {
    background: white;
    border-radius: 1rem;
    padding: 3rem 2.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .login-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .login-header svg {
    color: #667eea;
    margin-bottom: 1rem;
  }

  .login-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 1.75rem;
    color: #1f2937;
  }

  .login-header p {
    margin: 0;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .error-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #fee2e2;
    color: #991b1b;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    border: 1px solid #fecaca;
  }

  .error-message svg {
    flex-shrink: 0;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    color: #374151;
    font-size: 0.875rem;
  }

  .form-input {
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
  }

  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  .login-btn:active {
    transform: translateY(0);
  }

  .login-footer {
    margin-top: 1.5rem;
    text-align: center;
  }

  .login-footer a {
    color: #6b7280;
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s ease;
  }

  .login-footer a:hover {
    color: #667eea;
  }

  .demo-notice {
    margin-top: 2rem;
    padding: 1rem;
    background: #fef3c7;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .demo-notice code {
    background: white;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    color: #dc2626;
    font-weight: 600;
  }

  @media (max-width: 640px) {
    .login-card {
      padding: 2rem 1.5rem;
    }

    .login-header h1 {
      font-size: 1.5rem;
    }
  }
</style>