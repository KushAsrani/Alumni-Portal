---
export const prerender = false;

import { connectToDatabase } from '../../lib/db/mongodb';

let status = 'Testing...';
let error = '';
let collections: string[] = [];

try {
  const { db } = await connectToDatabase();
  
  // List collections
  collections = (await db.listCollections().toArray()).map(c => c.name);
  
  // Test query
  const jobsCount = await db.collection('jobs').countDocuments();
  
  status = `✅ Connected successfully! Found ${jobsCount} jobs.`;
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
  status = '❌ Connection failed';
}
---

<!DOCTYPE html>
<html>
<head>
  <title>MongoDB Connection Test</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f9fafb;
    }
    .status {
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    .success {
      background: #dcfce7;
      color: #166534;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
    }
    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>MongoDB Atlas Connection Test</h1>
  
  <div class={`status ${error ? 'error' : 'success'}`}>
    <strong>{status}</strong>
  </div>

  {error && (
    <div>
      <h2>Error Details:</h2>
      <pre>{error}</pre>
    </div>
  )}

  {collections.length > 0 && (
    <div>
      <h2>Collections:</h2>
      <ul>
        {collections.map(name => <li>{name}</li>)}
      </ul>
    </div>
  )}

  <div style="margin-top: 2rem;">
    <a href="/admin/scraper-dashboard">← Back to Dashboard</a>
  </div>
</body>
</html>