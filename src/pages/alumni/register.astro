---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getSiteConfig } from "../../utils/config";

const config = getSiteConfig();
---

<Layout title={`Join ${config.organization.name} — Alumni Registration`} description={`Register to join ${config.organization.name} alumni network.`}>
  <section class="section">
    <div class="container-custom max-w-4xl mx-auto">
      <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-accent-900 mb-2">Alumni Registration</h1>
        <p class="text-accent-600">Welcome! Fill in your details to join the {config.organization.name} alumni network.</p>
      </div>

      <form id="alumniForm" class="space-y-6 bg-white p-8 rounded-xl shadow-md" novalidate>
        <!-- Personal Information Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Personal Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Full Name <span class="text-red-500">*</span>
              </label>
              <input name="name" required class="input" placeholder="" aria-describedby="name-error" />
              <p id="name-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="name" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Email <span class="text-red-500">*</span>
              </label>
              <input name="email" type="email" required class="input" placeholder="" aria-describedby="email-error" />
              <p id="email-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="email" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Mobile Number <span class="text-red-500">*</span>
              </label>
              <input name="mobile" type="tel" required class="input" placeholder="" aria-describedby="mobile-error" />
              <p id="mobile-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="mobile" role="alert"></p>
              <p class="mt-1 text-xs text-accent-500">Include country code (e.g., +91 for India)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Date of Birth <span class="text-red-500">*</span>
              </label>
              <input name="dob" type="date" class="input" aria-describedby="dob-error"/>
              <p id="dob-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="dob" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Gender <span class="text-red-500">*</span>
              </label>
              <div class="space-y-2 mt-2" role="radiogroup" aria-labelledby="gender-label">
                <label id="gender-label" class="sr-only">Gender</label>
                <label class="flex items-center">
                  <input type="radio" name="gender" value="Male" required class="w-4 h-4 text-primary-600 focus:ring-primary-500" />
                  <span class="ml-2 text-accent-700">Male</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="gender" value="Female" required class="w-4 h-4 text-primary-600 focus:ring-primary-500" />
                  <span class="ml-2 text-accent-700">Female</span>
                </label>
              </div>
              <p id="gender-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="gender" role="alert"></p>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">
              Address
            </label>
            <textarea name="address" rows="2" class="input" placeholder="Street, City, State, Country"></textarea>
          </div>
        </div>

        <!-- Education Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Education</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                University/Institution <span class="text-red-500">*</span>
              </label>
              <input name="university" required class="input" placeholder="" aria-describedby="university-error" />
              <p class="mt-1 text-xs text-accent-500">Enter the name of your university or institution
              <p id="university-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="university" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                College Name <span class="text-red-500">*</span>
              </label>
              <input name="college_name" required class="input" placeholder="" aria-describedby="college_name-error" />
              <p class="mt-1 text-xs text-accent-500">Enter the name of your college</p>
              <p id="college_name-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="college_name" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Graduation Year <span class="text-red-500">*</span>
              </label>
              <input name="year" type="number" min="1950" max="2100" required class="input" placeholder="" aria-describedby="year-error" />
              <p class="mt-1 text-xs text-accent-500">Enter your year of graduation</p>
              <p id="year-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="year" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Faculty / Department <span class="text-red-500">*</span>
              </label>
              <input name="faculty" required class="input" placeholder="" aria-describedby="faculty-error" />
              <p class="mt-1 text-xs text-accent-500">Enter your field of study or department (e.g., Computer Science, IT, Computer Engineering, etc.)</p> 
              <p id="faculty-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="faculty" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Degree <span class="text-red-500">*</span>
              </label>
              <input name="degree" required class="input" placeholder="" aria-describedby="degree-error" />
              <p class="mt-1 text-xs text-accent-500">Enter your degree (e.g., B.Sc., MCA, B.Tech, M.Sc., etc.)</p>
              <p id="degree-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="degree" role="alert"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                CGPA or Percentage <span class="text-red-500">*</span>
              </label>
              <input name="gpa" type="text" required class="input" placeholder="" aria-describedby="g pa-error" />
              <p id="gpa-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="gpa" role="alert"></p>
              <p class="mt-1 text-xs text-accent-500">Enter CGPA (0.0-10.0) or Percentage (0-100%) as per your graduation marksheet</p>
            </div>
          </div>
        </div>

        <!-- Professional Information Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Professional Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Current Company</label>
              <input name="company" class="input" placeholder="" />
              <p class="mt-1 text-xs text-accent-500">Enter the name of your current company or organization</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Job Designation</label>
              <input name="job_designation" class="input" placeholder="" />
              <p class="mt-1 text-xs text-accent-500">Enter your current role or position (e.g., Software Engineer, Web Developer, Data Analyst, etc.)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Location</label>
              <input name="location" class="input" placeholder="City, Country" />
              <p class="mt-1 text-xs text-accent-500">Enter your current city and country (e.g., Mumbai, India)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">LinkedIn profile link</label>
              <input name="linkedin" type="url" class="input" placeholder="" />
              <p class="mt-1 text-xs text-accent-500">Provide a link to your LinkedIn profile</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">GitHub link</label>
              <input name="github" type="url" class="input" placeholder="" />
              <p class="mt-1 text-xs text-accent-500">Provide a link to your GitHub profile
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Twitter link</label>
              <input name="twitter" type="url" class="input" placeholder="" />
              <p class="mt-1 text-xs text-accent-500">Provide a link to your Twitter profile</p>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">Skills</label>
            <textarea name="skills" rows="2" class="input" placeholder="Separate skills with commas (e.g., JavaScript, React, Node.js, Python)"></textarea>
            <p class="mt-1 text-xs text-accent-500">List your technical and professional skills. Separate skills with commas (e.g., JavaScript, React, Node.js, Python)</p>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">Projects</label>
            <textarea name="projects" rows="3" class="input" placeholder="List your notable projects with brief descriptions"></textarea>
            <p class="mt-1 text-xs text-accent-500">List your notable projects with brief descriptions. Describe your key projects and achievements</p>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">Work Experience</label>
            <textarea name="work_experience" rows="4" class="input" placeholder="List your work experience with company names, positions, and durations"></textarea>
            <p class="mt-1 text-xs text-accent-500">List your work experience with company names, positions, and durations. Include company, role, duration, and key responsibilities</p>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">Interests</label>
            <textarea name="interests" rows="2" class="input" placeholder="Your professional and personal interests"></textarea>
            <p class="mt-1 text-xs text-accent-500">Share what you're passionate about</p>
          </div>
        </div>

        <!-- Photo Upload Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Profile Photo <span class="text-red-500">*</span></h2>
          
          <div class="flex items-start gap-6">
            <div class="flex-shrink-0">
              <div id="photoPreview" class="w-32 h-32 rounded-full bg-accent-100 flex items-center justify-center overflow-hidden border-2 border-accent-200">
                <svg class="w-12 h-12 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
            </div>
            
            <div class="flex-grow">
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Upload Photo <span class="text-red-500">*</span>
              </label>
              <input 
                type="file" 
                id="photoInput" 
                required
                accept="image/jpeg,image/jpg,image/png,image/webp" 
                class="block w-full text-sm text-accent-600
                  file:mr-4 file:py-2 file:px-4
                  file:rounded-lg file:border-0
                  file:text-sm file:font-semibold
                  file:bg-primary-50 file:text-primary-700
                  hover:file:bg-primary-100
                  cursor-pointer"
                aria-describedby="photo_blob_url-error"
              />
              <p class="mt-2 text-xs text-accent-500">
                Accepted formats: JPEG, PNG, WebP. Max size: 5MB
              </p>
              <p id="photo_blob_url-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="photo_blob_url" role="alert"></p>
              <div id="uploadProgress" class="hidden mt-2">
                <div class="w-full bg-accent-200 rounded-full h-2">
                  <div id="progressBar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-xs text-accent-600 mt-1">Uploading...</p>
              </div>
              <div id="uploadError" class="hidden mt-2 text-xs text-red-600" role="alert"></div>
            </div>
          </div>
          
          <input type="hidden" name="photo_blob_url" id="photoUrl" required />
        </div>

        <!-- Degree Certificate Upload Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Degree Certificate <span class="text-red-500">*</span></h2>
          
          <div>
            <label class="block text-sm font-medium text-accent-700 mb-2">
              Upload Degree Certificate <span class="text-red-500">*</span>
            </label>
            <input 
              type="file" 
              id="certificateInput"
              required
              accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/jpeg,image/jpg,image/png" 
              class="block w-full text-sm text-accent-600
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-secondary-50 file:text-secondary-700
                hover:file:bg-secondary-100
                cursor-pointer"
              aria-describedby="degree_certificate_url-error"
            />
            <p class="mt-2 text-xs text-accent-500">
              Accepted formats: PDF, DOC, DOCX, JPG, PNG. Max size: 10MB
            </p>
            <p id="degree_certificate_url-error" class="error-text hidden text-red-600 text-xs mt-1" data-error-for="degree_certificate_url" role="alert"></p>
            <div id="certificateProgress" class="hidden mt-2">
              <div class="w-full bg-accent-200 rounded-full h-2">
                <div id="certificateProgressBar" class="bg-secondary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <p class="text-xs text-accent-600 mt-1">Uploading certificate...</p>
            </div>
            <div id="certificateError" class="hidden mt-2 text-xs text-red-600" role="alert"></div>
            <div id="certificateSuccess" class="hidden mt-2 text-xs text-green-600 flex items-center" role="status">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Certificate uploaded successfully
            </div>
          </div>
          
          <input type="hidden" name="degree_certificate_url" id="certificateUrl" required />
        </div>

        <!-- Short Bio Section -->
        <div>
          <label class="block text-sm font-medium text-accent-700 mb-2">Your achievements</label>
          <textarea name="short_bio" rows="4" class="input" placeholder="Tell us about yourself, your achievements, and your professional journey..."></textarea>
        </div>

        <!-- Consent -->
        <div class="flex items-start gap-3">
          <input id="consent" name="consent" type="checkbox" required class="mt-1" />
          <label for="consent" class="text-accent-700 text-sm">
            I confirm that the information provided is accurate and I consent to having this information displayed in the alumni directory.
          </label>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit" id="submitBtn" class="btn btn-primary">
            <span id="submitText">Submit Registration</span>
            <span id="submitLoader" class="hidden">
              <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing...
            </span>
          </button>
        </div>

        <div id="formMessage" class="text-sm text-center mt-4 hidden" role="alert"></div>
      </form>
    </div>
  </section>

  <style>
    .input-error {
      border-color: #ef4444 !important;
      border-width: 2px;
    }
    .error-text.hidden { display: none; }
  </style>

  <script lang="js">
    // Plain JavaScript client script for Astro (no TypeScript)
    const form = document.getElementById('alumniForm');
    const msg = document.getElementById('formMessage');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitLoader = document.getElementById('submitLoader');

    // Photo upload elements
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const photoUrl = document.getElementById('photoUrl');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const uploadError = document.getElementById('uploadError');

    // Certificate upload elements
    const certificateInput = document.getElementById('certificateInput');
    const certificateUrl = document.getElementById('certificateUrl');
    const certificateProgress = document.getElementById('certificateProgress');
    const certificateProgressBar = document.getElementById('certificateProgressBar');
    const certificateError = document.getElementById('certificateError');
    const certificateSuccess = document.getElementById('certificateSuccess');

    let uploadedPhotoUrl = '';
    let uploadedCertificateUrl = '';

    if (!form) {
      console.warn('Alumni form not found on page.');
    } else {
      // Helper functions
      function getErrorElement(fieldName) {
        return document.querySelector('[data-error-for="' + fieldName + '"]');
      }

      function getInputElement(fieldName) {
        const elByName = document.querySelector('[name="' + fieldName + '"]');
        if (elByName) return elByName;
        return document.getElementById(fieldName);
      }

      function showFieldError(fieldName, message) {
        const errorElement = getErrorElement(fieldName);
        const inputElement = getInputElement(fieldName);

        if (errorElement) {
          if (!errorElement.id) errorElement.id = fieldName + '-error';
          errorElement.textContent = message;
          errorElement.classList.remove('hidden');
        }

        if (inputElement) {
          inputElement.classList.add('input-error');
          inputElement.setAttribute('aria-invalid', 'true');
          if (errorElement && errorElement.id) {
            inputElement.setAttribute('aria-describedby', errorElement.id);
          }
        }
      }

      function clearFieldError(fieldName) {
        const errorElement = getErrorElement(fieldName);
        const inputElement = getInputElement(fieldName);

        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }

        if (inputElement) {
          inputElement.classList.remove('input-error');
          inputElement.removeAttribute('aria-invalid');
          inputElement.removeAttribute('aria-describedby');
        }
      }

      function clearAllErrors() {
        document.querySelectorAll('.error-text').forEach(function(el) {
          el.textContent = '';
          el.classList.add('hidden');
        });
        document.querySelectorAll('.input-error').forEach(function(el) {
          el.classList.remove('input-error');
          el.removeAttribute('aria-invalid');
          el.removeAttribute('aria-describedby');
        });
        if (msg) {
          msg.classList.add('hidden');
          msg.textContent = '';
        }
      }

      // Real-time clearing
      const allInputs = form.querySelectorAll('input, textarea, select');
      allInputs.forEach(function(input) {
        input.addEventListener('input', function(event) {
          const target = event.target;
          const fieldName = target.getAttribute('name');
          if (fieldName) clearFieldError(fieldName);
        });
        input.addEventListener('change', function(event) {
          const target = event.target;
          const fieldName = target.getAttribute('name');
          if (fieldName) clearFieldError(fieldName);
        });
      });

      // Real-time clearing for DOB
      const dobInput = form.querySelector('input[name="dob"]');
      if (dobInput) {
        dobInput.addEventListener('input', function () {
          clearFieldError('dob');
        });
        dobInput.addEventListener('change', function () {
          clearFieldError('dob');
        });
      }

      // Real-time clearing for GPA
      const gpaInput = form.querySelector('input[name="gpa"]');
      if (gpaInput) {
        gpaInput.addEventListener('input', function () {
          clearFieldError('gpa');
        });
        gpaInput.addEventListener('change', function () {
          clearFieldError('gpa');
        });
      }

      // Photo upload
      if (photoInput && photoPreview && uploadProgress && progressBar && uploadError && photoUrl) {
        photoInput.addEventListener('change', async function(e) {
          const target = e.target;
          const file = (target.files && target.files[0]) || null;
          if (!file) return;

          const maxSize = 5 * 1024 * 1024;
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
          if (allowedTypes.indexOf(file.type) === -1) {
            showFieldError('photo_blob_url', 'Unsupported photo format. Use JPEG, PNG, or WebP.');
            return;
          }
          if (file.size > maxSize) {
            showFieldError('photo_blob_url', 'Photo must be under 5MB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(ev) {
            if (photoPreview) {
              photoPreview.innerHTML = '<img src="' + ev.target.result + '" class="w-full h-full object-cover" alt="Preview" />';
            }
          };
          reader.readAsDataURL(file);

          uploadError.classList.add('hidden');
          clearFieldError('photo_blob_url');
          uploadProgress.classList.remove('hidden');
          progressBar.style.width = '0%';

          try {
            const formData = new FormData();
            formData.append('photo', file);

            let progress = 0;
            const progressInterval = setInterval(function() {
              progress += 10;
              if (progress <= 90) progressBar.style.width = progress + '%';
            }, 100);

            const response = await fetch('/api/upload-photo', {
              method: 'POST',
              body: formData
            });

            clearInterval(progressInterval);
            progressBar.style.width = '100%';

            const result = await response.json();

            if (response.ok && result.success) {
              uploadedPhotoUrl = result.url;
              photoUrl.value = result.url;
              setTimeout(function() {
                uploadProgress.classList.add('hidden');
              }, 500);
            } else {
              uploadError.textContent = result && result.message ? result.message : 'Upload failed';
              uploadError.classList.remove('hidden');
              uploadProgress.classList.add('hidden');
              showFieldError('photo_blob_url', result && result.message ? result.message : 'Upload failed');
            }
          } catch (error) {
            console.error('Upload error:', error);
            uploadError.textContent = 'Failed to upload photo. Please try again.';
            uploadError.classList.remove('hidden');
            uploadProgress.classList.add('hidden');
            showFieldError('photo_blob_url', 'Failed to upload photo. Please try again.');
          }
        });
      }

      // Certificate upload
      if (certificateInput && certificateProgress && certificateProgressBar && certificateError && certificateSuccess && certificateUrl) {
        certificateInput.addEventListener('change', async function(e) {
          const target = e.target;
          const file = (target.files && target.files[0]) || null;
          if (!file) return;

          const maxSize = 10 * 1024 * 1024;
          const allowedTypes = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'image/jpeg',
            'image/jpg',
            'image/png'
          ];
          if (allowedTypes.indexOf(file.type) === -1) {
            showFieldError('degree_certificate_url', 'Unsupported certificate format. Use PDF, DOC, DOCX, JPG, or PNG.');
            return;
          }
          if (file.size > maxSize) {
            showFieldError('degree_certificate_url', 'Certificate must be under 10MB.');
            return;
          }

          certificateError.classList.add('hidden');
          certificateSuccess.classList.add('hidden');
          clearFieldError('degree_certificate_url');
          certificateProgress.classList.remove('hidden');
          certificateProgressBar.style.width = '0%';

          try {
            const formData = new FormData();
            formData.append('document', file);

            let progress = 0;
            const progressInterval = setInterval(function() {
              progress += 10;
              if (progress <= 90) certificateProgressBar.style.width = progress + '%';
            }, 100);

            const response = await fetch('/api/upload-document', {
              method: 'POST',
              body: formData
            });

            clearInterval(progressInterval);
            certificateProgressBar.style.width = '100%';

            const result = await response.json();

            if (response.ok && result.success) {
              uploadedCertificateUrl = result.url;
              certificateUrl.value = result.url;
              setTimeout(function() {
                certificateProgress.classList.add('hidden');
                certificateSuccess.classList.remove('hidden');
              }, 500);
            } else {
              certificateError.textContent = result && result.message ? result.message : 'Upload failed';
              certificateError.classList.remove('hidden');
              certificateProgress.classList.add('hidden');
              showFieldError('degree_certificate_url', result && result.message ? result.message : 'Upload failed');
            }
          } catch (error) {
            console.error('Upload error:', error);
            certificateError.textContent = 'Failed to upload certificate. Please try again.';
            certificateError.classList.remove('hidden');
            certificateProgress.classList.add('hidden');
            showFieldError('degree_certificate_url', 'Failed to upload certificate. Please try again.');
          }
        });
      }

      // Submit handler
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        clearAllErrors();

        const formData = new FormData(form);
        const payload = {};
        formData.forEach(function(value, key) {
          if (key !== 'consent') {
            payload[key] = value;
          }
        });

        if (uploadedPhotoUrl) payload.photo_blob_url = uploadedPhotoUrl;
        if (uploadedCertificateUrl) payload.degree_certificate_url = uploadedCertificateUrl;

        let hasErrors = false;
        let firstErrorField = '';

        // Name
        if (!payload.name || String(payload.name).trim() === '') {
          showFieldError('name', 'Please provide your name');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'name';
        }

        // Email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!payload.email || String(payload.email).trim() === '') {
          showFieldError('email', 'Please provide your email address');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'email';
        } else if (!emailRegex.test(String(payload.email))) {
          showFieldError('email', 'Please enter a valid email address');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'email';
        }

        // Mobile
        const mobileRegex = /^[+]?[\d\s\-()]{10,}$/;
        if (!payload.mobile || String(payload.mobile).trim() === '') {
          showFieldError('mobile', 'Please provide your mobile number');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'mobile';
        } else if (!mobileRegex.test(String(payload.mobile))) {
          showFieldError('mobile', 'Please enter a valid mobile number (at least 10 digits)');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'mobile';
        }

        // Date of Birth validation
        // Rules: required, valid date, not in future, age between 16 and 120
        (function validateDob() {
          const dobValue = payload.dob ? String(payload.dob).trim() : '';
          if (!dobValue) {
            showFieldError('dob', 'Please provide your date of birth');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = 'dob';
          } else {
            const dobDate = new Date(dobValue);
            const now = new Date();
            // invalid date check
            if (isNaN(dobDate.getTime())) {
              showFieldError('dob', 'Please enter a valid date');
              hasErrors = true;
              if (!firstErrorField) firstErrorField = 'dob';
            } else {
              // not in future
              if (dobDate > now) {
                showFieldError('dob', 'Date of birth cannot be in the future');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'dob';
              } else {
                // age check
                const ageDifMs = now - dobDate.getTime();
                const ageDate = new Date(ageDifMs);
                const age = Math.abs(ageDate.getUTCFullYear() - 1970);
                if (age < 16) {
                  showFieldError('dob', 'You must be at least 16 years old to register');
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = 'dob';
                } else if (age > 120) {
                  showFieldError('dob', 'Please enter a realistic date of birth');
                  hasErrors = true;
                  if (!firstErrorField) firstErrorField = 'dob';
                } else {
                  // valid — ensure payload contains normalized ISO date
                  payload.dob = dobDate.toISOString().split('T')[0];
                }
              }
            }
          }
        })();

        // Gender
        const genderChecked = form.querySelector('input[name="gender"]:checked');
        const genderValue = genderChecked ? genderChecked.value : '';
        if (!genderValue) {
          showFieldError('gender', 'Please select your gender');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'gender';
        } else {
          payload.gender = genderValue;
        }

        // University
        if (!payload.university || String(payload.university).trim() === '') {
          showFieldError('university', 'Please provide your university/institution name');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'university';
        }

        // College
        if (!payload.college_name || String(payload.college_name).trim() === '') {
          showFieldError('college_name', 'Please provide your college name');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'college_name';
        }

        // Year
        if (!payload.year || String(payload.year).trim() === '') {
          showFieldError('year', 'Please provide your graduation year');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'year';
        } else {
          const yearNum = Number(payload.year);
          if (Number.isNaN(yearNum) || yearNum < 1950 || yearNum > 2100) {
            showFieldError('year', 'Please enter a valid graduation year');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = 'year';
          }
        }

        // Faculty
        if (!payload.faculty || String(payload.faculty).trim() === '') {
          showFieldError('faculty', 'Please provide your faculty/department');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'faculty';
        }

        // Degree
        if (!payload.degree || String(payload.degree).trim() === '') {
          showFieldError('degree', 'Please provide your degree');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'degree';
        }

        // GPA validation
        // Rules: required, valid format (decimal 0.0-10.0 or percentage 0-100%)
        (function validateGpa() {
          const gpaValue = payload.gpa ? String(payload.gpa).trim() : '';
          if (!gpaValue) {
            showFieldError('gpa', 'Please provide your CGPA');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = 'gpa';
          } else {
            // Check if it's a percentage (contains %)
            const isPercentage = gpaValue.includes('%');
            let numericValue;
            
            if (isPercentage) {
              // Remove % and parse
              numericValue = parseFloat(gpaValue.replace('%', '').trim());
              if (isNaN(numericValue)) {
                showFieldError('gpa', 'Please enter a valid percentage (e.g., 85%)');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'gpa';
              } else if (numericValue < 0 || numericValue > 100) {
                showFieldError('gpa', 'Percentage must be between 0 and 100');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'gpa';
              } else {
                // Valid percentage - keep as is
                payload.gpa = numericValue + '%';
              }
            } else {
              // Assume it's a decimal GPA
              numericValue = parseFloat(gpaValue);
              if (isNaN(numericValue)) {
                showFieldError('gpa', 'Please enter a valid CGPA');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'gpa';
              } else if (numericValue < 0 || numericValue > 10.0) {
                showFieldError('gpa', 'CGPA must be between 0.0 and 10.0');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'gpa';
              } else {
                // Valid decimal GPA
                payload.gpa = numericValue.toFixed(2);
              }
            }
          }
        })();

        // Photo
        if (!uploadedPhotoUrl && (!payload.photo_blob_url || String(payload.photo_blob_url).trim() === '')) {
          showFieldError('photo_blob_url', 'Please upload your photo');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'photo_blob_url';
        }

        // Certificate
        if (!uploadedCertificateUrl && (!payload.degree_certificate_url || String(payload.degree_certificate_url).trim() === '')) {
          showFieldError('degree_certificate_url', 'Please upload your degree certificate');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'degree_certificate_url';
        }

        // Consent
        const consentChecked = document.getElementById('consent') && document.getElementById('consent').checked;
        if (!consentChecked) {
          showMessage('Please confirm consent to proceed.', 'error');
          hasErrors = true;
          if (!firstErrorField) firstErrorField = 'consent';
        }

        if (hasErrors) {
          if (firstErrorField) {
            const firstEl = getInputElement(firstErrorField);
            if (firstEl) {
              firstEl.focus();
              firstEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          }
          return;
        }

        // Submit
        setLoading(true);

        try {
          const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showMessage('Thank you! Your registration was submitted successfully. We will review your application and get back to you soon.', 'success');
            form.reset();
            if (photoPreview) {
              photoPreview.innerHTML = '<svg class="w-12 h-12 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
            }
            if (certificateSuccess) certificateSuccess.classList.add('hidden');
            uploadedPhotoUrl = '';
            uploadedCertificateUrl = '';
            if (photoUrl) photoUrl.value = '';
            if (certificateUrl) certificateUrl.value = '';

            setTimeout(function() {
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
          } else {
            showMessage((result && result.message) ? result.message : 'An error occurred. Please try again.', 'error');
          }
        } catch (error) {
          console.error('Registration error:', error);
          showMessage('An error occurred while submitting. Please check your connection and try again.', 'error');
        } finally {
          setLoading(false);
        }
      });

      function showMessage(text, type) {
        if (!msg) return;
        msg.textContent = text;
        msg.classList.remove('hidden', 'text-green-600', 'text-red-600');
        msg.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function setLoading(loading) {
        if (!submitBtn || !submitText || !submitLoader) return;
        submitBtn.disabled = loading;
        submitText.classList.toggle('hidden', loading);
        submitLoader.classList.toggle('hidden', !loading);
        
        if (loading) {
          submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
          submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
      }
    }
  </script>
</Layout>