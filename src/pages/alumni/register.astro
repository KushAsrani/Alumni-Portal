---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getSiteConfig } from "../../utils/config";

const config = getSiteConfig();
---

<Layout title={`Join ${config.organization.name} â€” Alumni Registration`} description={`Register to join ${config.organization.name} alumni network.`}>
  <section class="section">
    <div class="container-custom max-w-4xl mx-auto">
      <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-accent-900 mb-2">Alumni Registration</h1>
        <p class="text-accent-600">Welcome! Fill in your details to join the {config.organization.name} alumni network.</p>
      </div>

      <form id="alumniForm" class="space-y-6 bg-white p-8 rounded-xl shadow-md">
        
        <!-- Personal Information Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Personal Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Full name <span class="text-red-500">*</span>
              </label>
              <input name="name" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Email <span class="text-red-500">*</span>
              </label>
              <input name="email" type="email" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Mobile Number <span class="text-red-500">*</span>
              </label>
              <input name="mobile" type="tel" required class="input" placeholder="" pattern="[+]?[\d\s\-()]{10,}" title="Please enter a valid phone number (at least 10 digits)" />
              <p class="mt-1 text-xs text-accent-500">Include country code (e.g., +91 for India)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Date of Birth
              </label>
              <input name="dob" type="date" class="input" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Gender <span class="text-red-500">*</span>
              </label>
              <div class="space-y-2 mt-2">
                <label class="flex items-center">
                  <input type="radio" name="gender" value="Male" required class="w-4 h-4 text-primary-600 focus:ring-primary-500" />
                  <span class="ml-2 text-accent-700">Male</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="gender" value="Female" required class="w-4 h-4 text-primary-600 focus:ring-primary-500" />
                  <span class="ml-2 text-accent-700">Female</span>
                </label>
                </label>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">
              Address
            </label>
            <textarea name="address" rows="2" class="input" placeholder="Street, City, State, Country"></textarea>
          </div>
        </div>

        <!-- Education Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Education</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                University/Institution <span class="text-red-500">*</span>
              </label>
              <input name="university" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                College Name <span class="text-red-500">*</span>
              </label>
              <input name="college_name" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Graduation year <span class="text-red-500">*</span>
              </label>
              <input name="year" type="number" min="1950" max="2100" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Faculty / Department <span class="text-red-500">*</span>
              </label>
              <input name="faculty" required class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Degree <span class="text-red-500">*</span>
              </label>
              <input name="degree" required class="input" placeholder="" />
            </div>
          </div>
        </div>

        <!-- Professional Information Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Professional Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Current Company</label>
              <input name="company" class="input" placeholder="" />
            </div>

            <div>
              <label class="block text-sm font-medium text-accent-700 mb-2">Job Designation</label>
              <input name="job_designation" class="input" placeholder="" />
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-accent-700 mb-2">LinkedIn profile link</label>
            <input name="linkedin" type="url" class="input" placeholder="" />
          </div>
        </div>

        <!-- Photo Upload Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Profile Photo <span class="text-red-500">*</span></h2>
          
          <div class="flex items-start gap-6">
            <div class="flex-shrink-0">
              <div id="photoPreview" class="w-32 h-32 rounded-full bg-accent-100 flex items-center justify-center overflow-hidden border-2 border-accent-200">
                <svg class="w-12 h-12 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
            </div>
            
            <div class="flex-grow">
              <label class="block text-sm font-medium text-accent-700 mb-2">
                Upload Photo <span class="text-red-500">*</span>
              </label>
              <input 
                type="file" 
                id="photoInput" 
                required
                accept="image/jpeg,image/jpg,image/png,image/webp" 
                class="block w-full text-sm text-accent-600
                  file:mr-4 file:py-2 file:px-4
                  file:rounded-lg file:border-0
                  file:text-sm file:font-semibold
                  file:bg-primary-50 file:text-primary-700
                  hover:file:bg-primary-100
                  cursor-pointer"
              />
              <p class="mt-2 text-xs text-accent-500">
                Accepted formats: JPEG, PNG, WebP. Max size: 5MB
              </p>
              <div id="uploadProgress" class="hidden mt-2">
                <div class="w-full bg-accent-200 rounded-full h-2">
                  <div id="progressBar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-xs text-accent-600 mt-1">Uploading...</p>
              </div>
              <div id="uploadError" class="hidden mt-2 text-xs text-red-600"></div>
            </div>
          </div>
          
          <input type="hidden" name="photo_blob_url" id="photoUrl" required />
        </div>

        <!-- Degree Certificate Upload Section -->
        <div class="border-b border-accent-200 pb-6">
          <h2 class="text-xl font-semibold text-accent-900 mb-4">Degree Certificate <span class="text-red-500">*</span></h2>
          
          <div>
            <label class="block text-sm font-medium text-accent-700 mb-2">
              Upload Degree Certificate <span class="text-red-500">*</span>
            </label>
            <input 
              type="file" 
              id="certificateInput"
              required
              accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/jpeg,image/jpg,image/png" 
              class="block w-full text-sm text-accent-600
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-secondary-50 file:text-secondary-700
                hover:file:bg-secondary-100
                cursor-pointer"
            />
            <p class="mt-2 text-xs text-accent-500">
              Accepted formats: PDF, DOC, DOCX, JPG, PNG. Max size: 10MB
            </p>
            <div id="certificateProgress" class="hidden mt-2">
              <div class="w-full bg-accent-200 rounded-full h-2">
                <div id="certificateProgressBar" class="bg-secondary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <p class="text-xs text-accent-600 mt-1">Uploading certificate...</p>
            </div>
            <div id="certificateError" class="hidden mt-2 text-xs text-red-600"></div>
            <div id="certificateSuccess" class="hidden mt-2 text-xs text-green-600 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Certificate uploaded successfully
            </div>
          </div>
          
          <input type="hidden" name="degree_certificate_url" id="certificateUrl" required />
        </div>

        <!-- Short Bio Section -->
        <div>
          <label class="block text-sm font-medium text-accent-700 mb-2">Your achievements</label>
          <textarea name="short_bio" rows="4" class="input" placeholder="Tell us about yourself, your achievements, and your professional journey..."></textarea>
        </div>

        <!-- Consent -->
        <div class="flex items-start gap-3">
          <input id="consent" name="consent" type="checkbox" required class="mt-1" />
          <label for="consent" class="text-accent-700 text-sm">
            I confirm that the information provided is accurate and I consent to having this information displayed in the alumni directory.
          </label>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit" id="submitBtn" class="btn btn-primary">
            <span id="submitText">Submit Registration</span>
            <span id="submitLoader" class="hidden">
              <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing...
            </span>
          </button>
        </div>

        <div id="formMessage" class="text-sm text-center mt-4 hidden" role="alert"></div>
      </form>
    </div>
  </section>

  <script>
    const form = document.getElementById('alumniForm') as HTMLFormElement;
    const msg = document.getElementById('formMessage') as HTMLDivElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitText = document.getElementById('submitText') as HTMLSpanElement;
    const submitLoader = document.getElementById('submitLoader') as HTMLSpanElement;
    
    // Photo upload elements
    const photoInput = document.getElementById('photoInput') as HTMLInputElement;
    const photoPreview = document.getElementById('photoPreview') as HTMLDivElement;
    const photoUrl = document.getElementById('photoUrl') as HTMLInputElement;
    const uploadProgress = document.getElementById('uploadProgress') as HTMLDivElement;
    const progressBar = document.getElementById('progressBar') as HTMLDivElement;
    const uploadError = document.getElementById('uploadError') as HTMLDivElement;

    // Certificate upload elements
    const certificateInput = document.getElementById('certificateInput') as HTMLInputElement;
    const certificateUrl = document.getElementById('certificateUrl') as HTMLInputElement;
    const certificateProgress = document.getElementById('certificateProgress') as HTMLDivElement;
    const certificateProgressBar = document.getElementById('certificateProgressBar') as HTMLDivElement;
    const certificateError = document.getElementById('certificateError') as HTMLDivElement;
    const certificateSuccess = document.getElementById('certificateSuccess') as HTMLDivElement;

    let uploadedPhotoUrl = '';
    let uploadedCertificateUrl = '';

    // Photo preview and upload
    photoInput.addEventListener('change', async function(e) {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        photoPreview.innerHTML = `<img src="${e.target?.result}" class="w-full h-full object-cover" alt="Preview" />`;
      };
      reader.readAsDataURL(file);

      // Upload to server
      uploadError.classList.add('hidden');
      uploadProgress.classList.remove('hidden');
      progressBar.style.width = '0%';

      try {
        const formData = new FormData();
        formData.append('photo', file);

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress <= 90) {
            progressBar.style.width = `${progress}%`;
          }
        }, 100);

        const response = await fetch('/api/upload-photo', {
          method: 'POST',
          body: formData
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        const result = await response.json();

        if (response.ok && result.success) {
          uploadedPhotoUrl = result.url;
          photoUrl.value = result.url;
          setTimeout(() => {
            uploadProgress.classList.add('hidden');
          }, 500);
        } else {
          uploadError.textContent = result.message || 'Upload failed';
          uploadError.classList.remove('hidden');
          uploadProgress.classList.add('hidden');
        }
      } catch (error) {
        console.error('Upload error:', error);
        uploadError.textContent = 'Failed to upload photo. Please try again.';
        uploadError.classList.remove('hidden');
        uploadProgress.classList.add('hidden');
      }
    });

    // Certificate upload
    certificateInput.addEventListener('change', async function(e) {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      certificateError.classList.add('hidden');
      certificateSuccess.classList.add('hidden');
      certificateProgress.classList.remove('hidden');
      certificateProgressBar.style.width = '0%';

      try {
        const formData = new FormData();
        formData.append('document', file);

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress <= 90) {
            certificateProgressBar.style.width = `${progress}%`;
          }
        }, 100);

        const response = await fetch('/api/upload-document', {
          method: 'POST',
          body: formData
        });

        clearInterval(progressInterval);
        certificateProgressBar.style.width = '100%';

        const result = await response.json();

        if (response.ok && result.success) {
          uploadedCertificateUrl = result.url;
          certificateUrl.value = result.url;
          setTimeout(() => {
            certificateProgress.classList.add('hidden');
            certificateSuccess.classList.remove('hidden');
          }, 500);
        } else {
          certificateError.textContent = result.message || 'Upload failed';
          certificateError.classList.remove('hidden');
          certificateProgress.classList.add('hidden');
        }
      } catch (error) {
        console.error('Upload error:', error);
        certificateError.textContent = 'Failed to upload certificate. Please try again.';
        certificateError.classList.remove('hidden');
        certificateProgress.classList.add('hidden');
      }
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      
      msg.classList.add('hidden');
      msg.textContent = '';

      // Enhanced validation
      const formData = new FormData(form);
      const payload: Record<string, any> = {};
      formData.forEach((value, key) => {
        if (key !== 'consent') {
          payload[key] = value;
        }
      });

      // Add uploaded URLs
      if (uploadedPhotoUrl) {
        payload.photo_blob_url = uploadedPhotoUrl;
      }
      if (uploadedCertificateUrl) {
        payload.degree_certificate_url = uploadedCertificateUrl;
      }

      console.log('Submitting payload:', payload);

      // Validate required fields
      if (!payload.name || !payload.email) {
        showMessage('Please provide your name and email.', 'error');
        return;
      }

      if (!payload.mobile) {
        showMessage('Please provide your mobile number.', 'error');
        return;
      }

      if (!payload.gender) {
        showMessage('Please select your gender.', 'error');
        return;
      }

      if (!payload.university || !payload.college_name || !payload.year || !payload.faculty || !payload.degree) {
        showMessage('Please complete all required education fields.', 'error');
        return;
      }

      if (!uploadedPhotoUrl) {
        showMessage('Please upload your photo.', 'error');
        return;
      }

      if (!uploadedCertificateUrl) {
        showMessage('Please upload your degree certificate.', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(payload.email)) {
        showMessage('Please enter a valid email address.', 'error');
        return;
      }

      // Validate mobile number
      const mobileRegex = /^[+]?[\d\s\-()]{10,}$/;
      if (!mobileRegex.test(payload.mobile)) {
        showMessage('Please enter a valid mobile number (at least 10 digits).', 'error');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showMessage('Thank you! Your registration was submitted successfully.', 'success');
          form.reset();
          photoPreview.innerHTML = `
            <svg class="w-12 h-12 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          `;
          certificateSuccess.classList.add('hidden');
          uploadedPhotoUrl = '';
          uploadedCertificateUrl = '';
          setTimeout(() => {
            window.location.href = '#';
          }, 2000);
        } else {
          showMessage(result.message || 'An error occurred. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Registration error:', error);
        showMessage('An error occurred while submitting. Please check your connection and try again.', 'error');
      } finally {
        setLoading(false);
      }
    });

    function showMessage(text: string, type: 'success' | 'error') {
      msg.textContent = text;
      msg.classList.remove('hidden', 'text-green-600', 'text-red-600');
      msg.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function setLoading(loading: boolean) {
      submitBtn.disabled = loading;
      submitText.classList.toggle('hidden', loading);
      submitLoader.classList.toggle('hidden', !loading);
      
      if (loading) {
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
      } else {
        submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    }
  </script>
</Layout>